\section{Pseudocode Description}
This section presents key components of the designed TDMA protocol. 
First an informal description is given followed by relevant flowcharts and pseudocode examples. 
The model of the protocol is divided into the two phases - the setup phase and the loop phase. 

These phases will be described in the following subsections using the same model for a general device. 
That device can only know its local variables and what it receives via the \enquote{received} function.

\begin{table}[H]
	\begin{tabularx}{\textwidth}{l l X l}
		\toprule
		Name		& Type		& Description & Definition\\
		\midrule
		$n$			& integer	& The number of slots in the network & $n < 1$\\
		$k$			& integer	& The slot claimed by this device & $k \leq n - 1$\\
		$i$			& integer	& The current slot & $i \leq n$\\
		$x$			& clock		& A clock used for timing\\
		$\delta$ 	& integer	& The duration of a time slot & $\delta > 0$\\
		$\rho$		& integer	& The duration of a time slot reserved for kommunication & $\rho > \delta$ and $\rho \leq 0$\\
		\bottomrule
	\end{tabularx}
	\caption{The local variables every device has access to.}
	\label{tab:locals}
\end{table}\todo{This is not a definition, maybe constraint invariant restriction}

The local variables are as defined in \myref{tab:locals} and must follow the following global invariants:
\begin{itemize}
\item For all device pairs ${d_1, d_2}$ in the network, $d_1.k != d_2.k$
\item For all device pairs ${d_1, d_2}$ in the network, $d_1.n = d_2.n$
\item For all device pairs ${d_1, d_2}$ in the network, $d_1.i = d_2.i$
\item For every device $d$ in the network $d.k != n$
\end{itemize}

The invariants are necessary to make sure that no jamming occurs. 
This is accomplished by having the devices agree on the number of slots and current slot while no devices have the same slot. 
Finally, no device should occupy the last slot as this is used by new devices to connect to the network.

The devices is assumed to have an implementation of the \enquote{received} and \enquote{transmit} function.
The \enquote{transmit} function is simple, it sends a message over radio waves containing the parameters parsed into it.
The \enquote{received} function is harder, it takes some parameters which are set to the received values if any was received. 
It then returns true if a message was received; otherwise false.
                    
\subsection{General Case} % (fold)
\label{sub:general_case}
Generally the devices should be executing an infinite loop, which transmits and receives payloads.
This loop should only be stopped, when the network needs to be reconfigured.
However said reconfiguration and how to initiate a network are special cases and will be described in \myref{sub:special_cases}.
\todo[inline]{Informal description of main loop and payload processing} 

\begin{lstlisting}[style=pseudocode,mathescape=true,caption={Pseudocode example of the main loop}] 
Device$_{id} =$ local $n, i, k, \delta, \rho, \text{clock } x$ 
procedure mainLoop()
	while true do
		wait until $x \geq \delta$
		$x \leftarrow 0$
		$i \leftarrow (i \text{ mod } n) + 1$		// Update current slot
		if $i = k$ then
			$Update()$				// Updates the data to be sendt
			$transmit(i, n, id, data)$
		else 
			while $x \leq \rho$ do
				if $recived(i', n', id', data')$ then
					$remember(id', data')$
					goto process
				end
			end
		end
		process:
		$doWork()$	// Must take less time than $\delta - \rho$	
	end
\end{lstlisting}  

%\begin{lstlisting}[style=customc,mathescape=true,caption={Pseudocode example of the method that processes the payload}]  
%processPayload(rx_payload)
%  syncDevice(rx_payload) // Use information in payload to re-synchronise
%  switch(rx_payload.type)
%    case PING:
%      return
%    case ANNOUNCEMENT:
%      $d$ += 1
%      $n$ += 1
%      if(rx_payload.Worst_Case > $\delta$)
%        $\delta$ = rx_payload.Worst_Case
%      return
%    case ACTION:
%      if(rx_payload.target == $k$)
%        execute(rx_payload.instruction)
%      return         
%\end{lstlisting}
% subsection general_case (end)   
            