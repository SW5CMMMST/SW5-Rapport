\section{Pseudocode Description}
This section presents key components of the designed TDMA-based protocol. 
First an informal description is given followed by relevant flowcharts and pseudocode examples. 
The model of the protocol is divided into the two phases - the initilization phase and the loop phase. 

These phases will be described in the following subsections using the same model for a general device. 
That device can only know its local variables and what it receives via the \enquote{received} function.

\begin{table}[H]
    \begin{tabularx}{\textwidth}{l|l|X|l}
        \toprule
        Name                & Type      & Description & Constraint \\
        \midrule
        $n$                 & integer   & The number of slots in the network                        & $2 \leq n \leq 256$\\
        $k$                 & integer   & The slot claimed by this device                           & $1 \leq k \leq n - 1$\\
        $i$                 & integer   & The current slot                                          & $1 \leq i \leq n$\\
        $\delta$            & integer   & The duration of a time slot                               & $\delta = \delta_{com} + \delta_{proc}$\\
        $\delta_{com}$      & integer   & The duration of a time slot reserved for communication    & $0 < \delta_{com}$ \\
        $\delta_{proc}$     & integer   & The duration of a time slot reserved for processing       & $0 < \delta_{proc}$ \\
        $t_0$               & integer   & The minimum time to determine if a network exists         & $3 \times \delta \leq t_0$ \\
        $x$                 & clock     & A clock used for timing, and always running\\
        \bottomrule
    \end{tabularx}
    \caption{The local variables every device has access to.}
    \label{tab:locals}
\end{table}

The local variables are as defined in \myref{tab:locals} and must follow the following global invariants once they are connected:
\begin{itemize}
\item For all device pairs ${d_1, d_2}$ in the network, $d_1.k \neq d_2.k$
\item For all device pairs ${d_1, d_2}$ in the network, $d_1.n = d_2.n$
\item For all device pairs ${d_1, d_2}$ in the network, $d_1.i = d_2.i$
\item For every device $d$ in the network $d.k \neq n$
\end{itemize}

The invariants are necessary to make sure that no two devices transmit at the same time. 
This is accomplished by having the devices agree on the number of slots and current slot while no devices have the same slot. 
Finally, no device should occupy the last slot as this is used by new devices to connect to the network.

The devices are assumed to have an implementation of the \enquote{receive} and \enquote{transmit} function.
The \enquote{transmit} function is simple, it sends a message over radio waves containing the parameters parsed into it.
The \enquote{received} function is harder, it takes some parameters which are set to the received values if any was received. 
It then returns true if a message was received; otherwise false.
                    
\subsection{General Case} % (fold)
\label{sub:general_case}
Generally the devices should be executing an infinite loop, which transmits and receives payloads, an overview of this flow can be seen in \myref{fig:main_psuedo_flow}.
\todo{Add explanatory text for this}
\tikzfigure{PsuedoMainFlowDiagram}{Flow diagram showing how a device acts when connected to a network}{main_psuedo_flow}
This loop should only be stopped, when the network needs to be reconfigured.
However said reconfiguration and how to initiate a network are special cases and will be described in \myref{sub:setup}.


\begin{minipage}{\linewidth} %minpage to avoid page break

\begin{lstlisting}[style=pseudocode,mathescape=true,caption={Pseudocode example of the main loop}] 
Device$_{id} =$ local $n$, $i$, $k$, $\delta$, $\delta_{com}$, clock $x$ 
procedure mainLoop()
    while true do
        wait until $x \geq \delta$
        $x \leftarrow 0$
        $i \leftarrow (i \text{ mod } n) + 1$ // Update current slot
        if $i = k$ then
            update() // Updates the data to be sendt
            transmit($i$, $n$, $id$, $data$)
        else 
            while $x \leq \delta_{com}$ do
                if received($i'$, $n'$, $id'$, $data'$) then
                    remember($id'$, $data'$)
                    goto process
                end
            end
        end
        process:
        doWork() // Must take less time than $\textcolor{green!50!black}{\delta - \delta_{com}}$ which is $\textcolor{green!50!black}{\delta_{proc}}$    
    end
\end{lstlisting}  
\end{minipage}
% subsection general_case (end)   
            